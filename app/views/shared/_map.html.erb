<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>

<div style='width: 640px;'>
  <div id="map" style='width: 640px; height: 640px;'></div>
</div>

<script>
    map_style = [{featureType:"water",elementType:"geometry",stylers:[{color:"#a2daf2"}]},{featureType:"landscape.man_made",elementType:"geometry",stylers:[{color:"#f7f1df"}]},{featureType:"landscape.natural",elementType:"geometry",stylers:[{color:"#d0e3b4"}]},{featureType:"landscape.natural.terrain",elementType:"geometry",stylers:[{visibility:"off"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#bde6ab"}]},{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.medical",elementType:"geometry",stylers:[{color:"#fbd3da"}]},{featureType:"poi.business",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#ffe15f"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#efd151"}]},{featureType:"road.arterial",elementType:"geometry.fill",stylers:[{color:"#ffffff"}]},{featureType:"road.local",elementType:"geometry.fill",stylers:[{color:"black"}]},{featureType:"transit.station.airport",elementType:"geometry.fill",stylers:[{color:"#cfb2db"}]}]
    map_options = { maxZoom: 20, styles: map_style }
    handler = Gmaps.build('Google');
    handler.buildMap({ provider: map_options, internal: {id: 'map'} }, function(){
//        SETS USER MARKER
        user_marker = handler.addMarkers(<%= raw @user_marker.to_json %>, {draggable: true});

//        SETS USER RADIUS
        user_radius = [{lng: <%= @user.longitude %>, lat: <%= @user.latitude %>, radius: 500 }];
        radius_options = { strokeColor:"#0000FF",strokeOpacity: 1, strokeWeight: 0, fillColor: '#007d53' };


//        FILLS MAP WITH USER, RADIUS, AND PINGAS
        handler.addCircles(user_radius, radius_options);
//        SETS PINGA MARKERS
        console.log(<%=raw @active_pinga_markers.to_json %>);
        active_pingas = handler.addMarkers(<%=raw @active_pinga_markers.to_json %>);
        pending_pingas = handler.addMarkers(<%=raw @pending_pinga_markers.to_json %>);
        grey_pingas = handler.addMarkers(<%=raw @grey_pinga_markers.to_json %>);
        console.log(active_pingas);

        handler.bounds.extendWith(active_pingas);
        handler.bounds.extendWith(pending_pingas);
        handler.bounds.extendWith(user_marker);

        handler.fitMapToBounds();
//        CENTERS ON USER
        handler.map.centerOn({ lat: <%= @user.latitude %>, lng: <%= @user.longitude %> });

    });
</script>